/**
 * jeefo_preprocessor : v0.0.1
 * Author             : je3f0o, <je3f0o@gmail.com>
 * Homepage           : https://github.com/je3f0o/jeefo_preprocessor
 * License            : The MIT License
 * Copyright          : 2017
 **/
"use strict";module.exports=function(e){return e.use(function(){var t=e.module("jeefo_preprocessor",["jeefo_javascript_beautifier"]);t.namespace("javascript.Preprocessor",["object.assign","javascript.Beautifier"],function(e,t){var s=function(e,t){this.parent=e,this.children=[],e?(this.defs=this.assign({},e.defs,t),this.level=e.level+1):(this.defs=this.assign({},t),this.level=0)},n=s.prototype;n.Scope=s,n.assign=e,n.$new=function(){var e=new this.Scope(this);return this.children.push(e),e},n.$destroy=function(){var e=this.parent.children.indexOf(this);return this.parent.children.splice(e,1),this.parent};var i=function(e,s,n,i){this.file=e,this.scope=new this.Scope(null,s),this.result=e.code,this.actions=[],this.compiler=new t(n||"",i||"\t"),this.cache={}};return n=i.prototype,n.Scope=s,n.Def=function(e,t){if(this.token=e,t)switch(t.type){case"Identifier":this.is_return="null"!==t.name&&"false"!==t.name}else this.is_return=!1},n.replace_between=function(e){this.result=this.result.substr(0,e.start)+e.replacement+this.result.substr(e.end)},n.remove=function(e){this.result=this.result.substr(0,e.start)+this.result.substr(e.end)},n.register=function(e,t){t.type=e,this.actions.push(t)},n.define=function(e,t){var s,n,i=0,r=[];switch(e[0].type){case"StringLiteral":s=t.defs[e[0].value]=new this.Def(e[1],e[2]);break;case"Identifier":s=t.defs[e[0].name]=new this.Def(e[1],e[2])}switch(s.token.type){case"FunctionExpression":var a=s.params=new Array(s.token.parameters.length);for(i=a.length-1;i>=0;--i)-1!==a.indexOf(s.token.parameters[i].name)&&s.token.parameters[i].error("Duplicated parameter"),a[i]={ids:[],name:s.token.parameters[i].name};for(this.find("Identifier",s.token.body,r),i=0;i<a.length;++i){for(n=0;n<r.length;++n)a[i].name===r[n].name&&a[i].ids.push(r[n]);a[i]=a[i].ids}break;default:s.compiled=this.compiler.compile(s.token)}},n.find=function(e,t,s,n){var i=0;switch(n=n,t.type){case e:s.push(t);break;case"Program":for(;i<t.body.length;++i)this.find(e,t.body[i],s,t);break;case"ObjectLiteral":for(;i<t.properties.length;++i)this.find(e,t.properties[i].value,s,t);break;case"ArrayLiteral":for(;i<t.elements.length;++i)this.find(e,t.elements[i],s,t);break;case"BinaryExpression":case"LogicalExpression":this.find(e,t.left,s,t),this.find(e,t.right,s,t);break;case"IfStatement":this.find(e,t.test,s,t),this.find(e,t.statement,s,t),t.alternate&&this.find(e,t.alternate,s,t);break;case"ForStatement":t.init&&this.find(e,t.init,s,t),t.test&&this.find(e,t.test,s,t),t.update&&this.find(e,t.update,s,t),this.find(e,t.statement,s,t);break;case"ReturnStatement":t.argument&&this.find(e,t.argument,s,t);break;case"BlockStatement":for(;i<t.body.length;++i)this.find(e,t.body[i],s,t);break;case"ExpressionStatement":this.find(e,t.expression,s,t);break;case"AssignmentExpression":this.find(e,t.left,s,t),this.find(e,t.right,s,t);break;case"MemberExpression":this.find(e,t.object,s,t),this.find(e,t.property,s,t);break;case"NewExpression":this.find(e,t.callee,s,t);break;case"CallExpression":for(this.find(e,t.callee,s,t);i<t.arguments.length;++i)this.find(e,t.arguments[i],s,t);break;case"UnaryExpression":case"ReturnStatement":this.find(e,t.argument,s,t);break;case"VariableDeclaration":for(;i<t.declarations.length;++i)t.declarations[i].init&&this.find(e,t.declarations[i].init,s,t);break;case"SwitchStatement":for(i=0;i<t.cases.length;++i)this.find(e,t.cases[i],s,t);break;case"SwitchCase":for(this.find(e,t.test,s),i=0;i<t.statements.length;++i)this.find(e,t.statements[i],s,t);break;case"FunctionExpression":for(;i<t.parameters.length;++i)this.find(e,t.parameters[i],s,t);this.find(e,t.body,s,t)}},n.call_expression=function(e,t,s){var n=new Array(e.arguments.length),i=n.length-1,r=0,a=[];for(this.compiler.current_indent="";i>=0;--i){switch(e.arguments[i].type){case"Identifier":s.defs.hasOwnProperty(e.arguments[i].name)&&(n[i]=s.defs[e.arguments[i].name].compiled)}n[i]||(n[i]=this.compiler.compile(e.arguments[i]))}for(i=s.level-1;i>=1;--i)this.compiler.current_indent=this.compiler.current_indent+this.compiler.indentation;for(i=t.params.length-1;i>=0;--i)for(r=t.params[i].length-1;r>=0;--r)t.params[i][r].compiled=n[i];if(this.current_expression||(this.current_expression=e),this.process(t.token.body.body,s),t.is_return){e:for(i=0;i<t.token.body.body.length;++i)if("ReturnStatement"===t.token.body.body[i].type){a.push(this.compiler.compile(t.token.body.body[i].argument));break e}}else for(i=0;i<t.token.body.body.length;++i)a.push(this.compiler.current_indent+this.compiler.compile(t.token.body.body[i]));this.current_expression===e?(this.register("replace",{start:e.start.index,end:e.end.index,replacement:a.join("\n").trim()}),this.current_expression=null):e.compiled=a.join("\n").trim()},n.expression=function(e,t){var s=0;switch(e.type){case"Comment":return;case"NumberLiteral":case"StringLiteral":case"RegExpLiteral":return;case"Identifier":t.defs.hasOwnProperty(e.name)&&!this.remove_indices&&this.register("replace",{start:e.start.index,end:e.end.index,replacement:t.defs[e.name].compiled});break;case"CallExpression":switch(e.callee.type){case"MemberExpression":"PP"===e.callee.object.name&&"define"===e.callee.property.name?this.define(e.arguments,t):this.remove_indices||(this.process_arguments(e.arguments,t),this.expression(e.callee,t));break;case"Identifier":t.defs.hasOwnProperty(e.callee.name)?this.call_expression(e,t.defs[e.callee.name],t):this.remove_indices||(this.process_arguments(e.arguments,t),this.expression(e.callee,t));break;case"FunctionExpression":this.process_arguments(e.arguments,t),this.expression(e.callee,t)}break;case"AssignmentExpression":this.expression(e.left,t),this.expression(e.right,t);break;case"BinaryExpression":case"LogicalExpression":this.expression(e.left,t),this.expression(e.right,t);break;case"FunctionExpression":this.process(e.body.body,t.$new());break;case"MemberExpression":this.expression(e.object,t),this.expression(e.property,t);break;case"NewExpression":for(this.expression(e.callee,t),s=e.arguments.length-1;s>=0;--s)this.expression(e.arguments[s],t);break;case"UnaryExpression":this.expression(e.argument,t);break;case"ArrayLiteral":break;case"Property":this.expression(e.value,t);break;case"ObjectLiteral":for(s=e.properties.length-1;s>=0;--s)this.expression(e.properties[s],t);break;case"ConditionalExpression":this.expression(e.test,t),e.consequent&&this.expression(e.consequent,t),e.alternate&&this.expression(e.alternate,t);break;case"SequenceExpression":for(s=e.expressions.length-1;s>=0;--s)this.expression(e.expressions[s],t);break;case"VariableDeclaration":this.variable_declaration(e.declarations,t);break;case"TemplateLiteral":if(this.remove_indices)return;for(s=e.body.length-1;s>=0;--s)"TemplateLiteralExpression"===e.body[s].type&&this.expression(e.body[s].expression,t);e.compiled=this.compiler.compile(e),this.register("replace",{start:e.start.index,end:e.end.index,replacement:e.compiled});break;default:console.log("UNIMPLEMENTED expression",e.type)}},n.process_arguments=function(e,t){for(var s=e.length-1;s>=0;this.expression(e[s],t),--s);},n.variable_declaration=function(e,t){for(var s=0;s<e.length;++s)e[s].init&&this.expression(e[s].init,t)},n.statement=function(e,t){switch(e.type){case"BlockStatement":this.process(e.body,t.$new());break;case"IfStatement":this.process([e],t);break;case"ForStatement":case"SwitchStatement":this.process([e],t);break;case"EmptyStatement":break;default:console.log("UNIMPLEMENTED statement",e.type)}},n.process=function(e,t){for(var s=0;s<e.length;++s)e:switch(e[s].type){case"Comment":switch(e[s].comment.trim()){case"ignore:start":this.remove_indices||(this.remove_indices={start:e[s].start.index,end:e[s].end.index},this.register("remove",this.remove_indices));break e;case"ignore:end":this.remove_indices?(this.remove_indices.end=e[s].end.index,this.remove_indices=null):console.warn("Unexpected ignore end.")}break;case"ExpressionStatement":this.expression(e[s].expression,t);break;case"ThrowStatement":case"ReturnStatement":e[s].argument&&this.expression(e[s].argument,t);break;case"IfStatement":this.expression(e[s].test,t),this.statement(e[s].statement,t),e[s].alternate&&this.statement(e[s].alternate,t);break;case"LabeledStatement":this.statement(e[s].statement,t);break;case"ForStatement":e[s].init&&this.expression(e[s].init,t),e[s].test&&this.expression(e[s].test,t),e[s].update&&this.expression(e[s].update,t),this.statement(e[s].statement,t);break;case"WhileStatement":this.statement(e[s].statement,t);break;case"SwitchStatement":t.level+=1,this.process(e[s].cases,t),t.level-=1;break;case"TryStatement":this.statement(e[s].block,t),e[s].handler&&(this.expression(e[s].handler.param,t),this.statement(e[s].handler.body,t)),e[s].finalizer&&this.statement(e[s].finalizer,t);break;case"BreakStatement":case"ContinueStatement":e[s].label&&this.expression(e[s].label,t);break;case"VariableDeclaration":this.variable_declaration(e[s].declarations,t);break;case"FunctionDeclaration":this.process(e[s].body.body,t.$new());break;case"SwitchCase":this.expression(e[s].test,t),this.process(e[s].statements,t.$new());break;case"DefaultCase":this.process(e[s].statements,t.$new());break;default:console.log("UNIMPLEMENTED token",e[s].type)}},i}),t.namespace("javascript.ES5_preprocessor",["javascript.ES5_parser","javascript.Preprocessor"],function(e,t){var s=function(e,s){this.pp=new t({},e),this.scope=this.pp.scope,this.middlewares=s||[]},n=s.prototype;n.Scope=t.prototype.Scope,n.parser=e,n.JavascriptPreprocessor=t,n.define=function(t,s,n){var i="PP.define("+t+", "+s.toString()+", "+n+");",r=e("[IN MEMORY]",i);this.pp.compiler.current_indent="",this.scope=new this.Scope(null,this.scope.defs),this.pp.process(r.program.body,this.scope)},n.$new=function(){return new s(this.scope.defs,this.middlewares.concat())},n.middleware=function(e){this.middlewares.push(e)},n.get_defs=function(e){return new this.Scope(this.scope,e).defs},n.process=function(e,t,s,n,i){for(var r=0,a=this.parser(e,t),o=new this.JavascriptPreprocessor(a,this.get_defs(s),n,i);r<this.middlewares.length;++r)this.middlewares[r](o);for(o.process(a.program.body,o.scope),o.actions.sort(function(e,t){return e.start-t.start}),r=o.actions.length-1;r>=0;--r)switch(o.actions[r].type){case"remove":o.remove(o.actions[r]);break;case"replace":o.replace_between(o.actions[r])}return o.result};var i=new s;return i.define("IS_NULL",function(e){return null===e},!0),i.define("IS_DEFINED",function(e){return void 0!==e},!0),i.define("IS_UNDEFINED",function(e){return void 0===e},!0),i.define("IS_NUMBER",function(e){return"number"===typeof e},!0),i.define("IS_STRING",function(e){return"string"===typeof e},!0),i.define("IS_BOOLEAN",function(e){return"boolean"===typeof e},!0),i.define("IS_FUNCTION",function(e){return"function"===typeof e},!0),i.define("IS_OBJECT",function(e){return null!==e&&"object"===typeof e},!0),i.define("ARRAY_EXISTS",function(e,t){return e.indexOf(t)>=0},!0),i.define("ARRAY_NOT_EXISTS",function(e,t){return-1===e.indexOf(t)},!0),i.define("IS_JEEFO_PROMISE",function(e){return e&&"JEEFO_PROMISE"===e.type},!0),i})}),e};